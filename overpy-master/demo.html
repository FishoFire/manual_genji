<!--
 * This file is part of OverPy (https://github.com/Zezombye/overpy).
 * Copyright (c) 2019 Zezombye.
 * 
 * This program is free software: you can redistribute it and/or modify  
 * it under the terms of the GNU General Public License as published by  
 * the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful, but 
 * WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU 
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License 
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
-->
<!--stfu firefox -->
<!DOCTYPE html>
<html>
	<head>
<meta charset="utf-8">
<link rel="icon" type="image/png" href="VS Code Extension/img/overpy.ico"/>
<title>OverPy Demo</title>

<style>
textarea {
	resize: vertical;
    -moz-tab-size: 4;
      -o-tab-size: 4;
         tab-size: 4;
}

body, textarea {
	color: #CCCCCC;
	background-color: #222222;
	scrollbar-color: #CCCCCC #222222;
}

a {
	color: lightblue;
}

.cm-editor {
	width: 100%;
	text-align: left;
	border: 2px solid gray;
	color: #CCCCCC;
	height: 320px;
}

.cm-content {
	
	white-space: pre-wrap !important;
	word-break: break-word !important;
	max-width: calc(100% - 32px);
}

.cm-cursor {
	border-color: #CCCCCC !important;
}

.cm-selectionBackground, ::selection {
	background-color: rgb(51, 153, 255) !important;
}

</style>
</head>
<body>
<center>
	<a href="https://github.com/Zezombye/overpy"><h1>OverPy v6 language demo by Zezombye</h1></a>
	<p><a href="https://github.com/Zezombye/overpy/blob/master/FUNCTIONS.md">Function documentation</a> | <button onclick="demoAddText();">Add example text</button> | Language: 
		<select id="languageInput">
			<option value="en-US">English [en-US]</option>
			<option value="de-DE">Deutsch [de-DE]</option>
			<option value="es-ES">Español (EU) [es-ES]</option>
			<option value="es-MX">Español (AL) [es-MX]</option>
			<option value="fr-FR">Français [fr-FR]</option>
			<option value="it-IT">Italiano [it-IT]</option>
			<option value="ja-JP">日本語 [ja-JP]</option>
			<option value="ko-KR">한국어 [ko-KR]</option>
			<option value="pl-PL">Polski [pl-PL]</option>
			<option value="pt-BR">Português [pt-BR]</option>
			<option value="ru-RU">Русский [ru-RU]</option>
			<option value="zh-CN">简体中文 [zh-CN]</option>
			<option value="zh-TW">繁體中文 [zh-TW]</option>
		</select>
	</p>
    
	<div id="workshop-text" style="float:left; width:33%;">
		<p>Workshop text</p>
		<button onclick="demoDecompile()">Decompile</button>
		<textarea id="workshop-textarea" onkeyup="getTextareaLineNumber(this, 'workshop');" onmouseup="this.onkeyup();" rows="20" style="width:100%;" wrap="off" placeholder="Note: the decompiler only supports code copied directly from Overwatch.&#10;&#10;If you wish to decompile code generated by a third-party tool (including OverPy),&#10;paste it into Overwatch and copy it."></textarea> 
		<p style="float:left;">line <span id="workshop-textarea-line-number"></span>, col <span id="workshop-textarea-col-number"></span></p>
	</div>
	
	<div id="overpy-text" style="float:left; width:33%;">
		<p>OverPy text</p>
		<button onclick="demoCompile()">Compile</button>
		<div id="cm-overpy-text"></div>
		<!--<textarea id="overpy-textarea" onkeyup="getTextareaLineNumber(this, 'overpy');" onmouseup="this.onkeyup();" rows="20" style="width:100%;" wrap="off"></textarea> 
		<p style="float:left;">line <span id="overpy-textarea-line-number"></span>, col <span id="overpy-textarea-col-number"></span></p>-->
	</div>
	
	<div id="compiled-text" style="float:right; width:34%;">
		<p>Compiled text</p>
		<button style="visibility: hidden;">hidden</button>
		<textarea id="compiled-textarea" onkeyup="getTextareaLineNumber(this, 'compiled');" onmouseup="this.onkeyup();" rows="20" style="width:100%;" wrap="off"></textarea> 
		<p style="float:left;">line <span id="compiled-textarea-line-number"></span>, col <span id="compiled-textarea-col-number"></span></p>
	</div>
</center>


<script src="src/utils/other.js"></script>

<script src="src/data/opy/stringEntities.js"></script>
<script src="src/data/opy/constants.js"></script>
<script src="src/data/opy/modules.js"></script>
<script src="src/data/opy/internalFunctions.js"></script>
<script src="src/data/opy/functions.js"></script>
<script src="src/data/opy/keywords.js"></script>
<script src="src/data/opy/memberFunctions.js"></script>
<script src="src/data/actions.js"></script>
<script src="src/data/values.js"></script>
<script src="src/data/maps.js"></script>
<script src="src/data/heroes.js"></script>
<script src="src/data/gamemodes.js"></script>
<script src="src/data/constants.js"></script>
<script src="src/data/other.js"></script>
<script src="src/data/customGameSettings.js"></script>
<script src="src/data/opy/preprocessing.js"></script>
<script src="src/data/opy/annotations.js"></script>

<script src="src/globalVars.js"></script>

<script src="src/utils/logging.js"></script>
<script src="src/utils/ast.js"></script>
<script src="src/utils/types.js"></script>
<script src="src/utils/compilation.js"></script>
<script src="src/utils/decompilation.js"></script>
<script src="src/utils/file.js"></script>
<script src="src/utils/optimization.js"></script>
<script src="src/utils/strings.js"></script>
<script src="src/utils/translation.js"></script>
<script src="src/utils/varNames.js"></script>
<script src="src/utils/tokens.js"></script>

<script src="src/decompiler/decompileTest.js"></script>
<script src="src/decompiler/workshopToAst.js"></script>
<script src="src/decompiler/astToOpy.js"></script>
<script src="src/decompiler/decompiler.js"></script>
<script src="src/decompiler/tokenizer.js"></script>

<script src="src/compiler/obfuscation.js"></script>
<script src="src/compiler/functions/__add__.js"></script>
<script src="src/compiler/functions/__and__.js"></script>
<script src="src/compiler/functions/__append__.js"></script>
<script src="src/compiler/functions/__array__.js"></script>
<script src="src/compiler/functions/__arraySlice__.js"></script>
<script src="src/compiler/functions/__assignTo__.js"></script>
<script src="src/compiler/functions/__button__.js"></script>
<script src="src/compiler/functions/__chaseAtRate__.js"></script>
<script src="src/compiler/functions/__chaseOverTime__.js"></script>
<script src="src/compiler/functions/__color__.js"></script>
<script src="src/compiler/functions/__del__.js"></script>
<script src="src/compiler/functions/__dict__.js"></script>
<script src="src/compiler/functions/__distanceTo__.js"></script>
<script src="src/compiler/functions/__divide__.js"></script>
<script src="src/compiler/functions/__doWhile__.js"></script>
<script src="src/compiler/functions/__elif__.js"></script>
<script src="src/compiler/functions/__else__.js"></script>
<script src="src/compiler/functions/__equals__.js"></script>
<script src="src/compiler/functions/__for__.js"></script>
<script src="src/compiler/functions/__format__.js"></script>
<script src="src/compiler/functions/__filteredArray__.js"></script>
<script src="src/compiler/functions/__gamemode__.js"></script>
<script src="src/compiler/functions/__globalVar__.js"></script>
<script src="src/compiler/functions/__greaterThan__.js"></script>
<script src="src/compiler/functions/__greaterThanOrEquals__.js"></script>
<script src="src/compiler/functions/__hero__.js"></script>
<script src="src/compiler/functions/__if__.js"></script>
<script src="src/compiler/functions/__ifThenElse__.js"></script>
<script src="src/compiler/functions/__indexOfArrayValue__.js"></script>
<script src="src/compiler/functions/__inequals__.js"></script>
<script src="src/compiler/functions/__lastOf__.js"></script>
<script src="src/compiler/functions/__lessThan__.js"></script>
<script src="src/compiler/functions/__lessThanOrEquals__.js"></script>
<script src="src/compiler/functions/__map__.js"></script>
<script src="src/compiler/functions/__mappedArray__.js"></script>
<script src="src/compiler/functions/__modulo__.js"></script>
<script src="src/compiler/functions/__multiply__.js"></script>
<script src="src/compiler/functions/__negate__.js"></script>
<script src="src/compiler/functions/__number__.js"></script>
<script src="src/compiler/functions/__not__.js"></script>
<script src="src/compiler/functions/__or__.js"></script>
<script src="src/compiler/functions/__playerVar__.js"></script>
<script src="src/compiler/functions/__raiseToPower__.js"></script>
<script src="src/compiler/functions/__remove__.js"></script>
<script src="src/compiler/functions/__reverse__.js"></script>
<script src="src/compiler/functions/__rule__.js"></script>
<script src="src/compiler/functions/__skip__.js"></script>
<script src="src/compiler/functions/__subtract__.js"></script>
<script src="src/compiler/functions/__switch__.js"></script>
<script src="src/compiler/functions/__team__.js"></script>
<script src="src/compiler/functions/__valueInArray__.js"></script>
<script src="src/compiler/functions/__wait__.js"></script>
<script src="src/compiler/functions/__while__.js"></script>
<script src="src/compiler/functions/__xComponentOf__.js"></script>
<script src="src/compiler/functions/__yComponentOf__.js"></script>
<script src="src/compiler/functions/__zComponentOf__.js"></script>
<script src="src/compiler/functions/_&addToScore.js"></script>
<script src="src/compiler/functions/_&setStatusEffect.js"></script>
<script src="src/compiler/functions/_&setUltCharge.js"></script>
<script src="src/compiler/functions/abs.js"></script>
<script src="src/compiler/functions/acos.js"></script>
<script src="src/compiler/functions/acosDeg.js"></script>
<script src="src/compiler/functions/addToTeamScore.js"></script>
<script src="src/compiler/functions/all.js"></script>
<script src="src/compiler/functions/any.js"></script>
<script src="src/compiler/functions/asin.js"></script>
<script src="src/compiler/functions/asinDeg.js"></script>
<script src="src/compiler/functions/atan2.js"></script>
<script src="src/compiler/functions/atan2Deg.js"></script>
<script src="src/compiler/functions/break.js"></script>
<script src="src/compiler/functions/ceil.js"></script>
<script src="src/compiler/functions/continue.js"></script>
<script src="src/compiler/functions/cos.js"></script>
<script src="src/compiler/functions/cosDeg.js"></script>
<script src="src/compiler/functions/createBeam.js"></script>
<script src="src/compiler/functions/createEffect.js"></script>
<script src="src/compiler/functions/createWorkshopSetting.js"></script>
<script src="src/compiler/functions/crossProduct.js"></script>
<script src="src/compiler/functions/directionTowards.js"></script>
<script src="src/compiler/functions/disableInspector.js"></script>
<script src="src/compiler/functions/distance.js"></script>
<script src="src/compiler/functions/dotProduct.js"></script>
<script src="src/compiler/functions/enableInspector.js"></script>
<script src="src/compiler/functions/eventPlayer.js"></script>
<script src="src/compiler/functions/floor.js"></script>
<script src="src/compiler/functions/getAllPlayers.js"></script>
<script src="src/compiler/functions/getCurrentMap.js"></script>
<script src="src/compiler/functions/getOppositeTeam.js"></script>
<script src="src/compiler/functions/len.js"></script>
<script src="src/compiler/functions/lineIntersectsSphere.js"></script>
<script src="src/compiler/functions/log.js"></script>
<script src="src/compiler/functions/max.js"></script>
<script src="src/compiler/functions/min.js"></script>
<script src="src/compiler/functions/normalize.js"></script>
<script src="src/compiler/functions/playEffect.js"></script>
<script src="src/compiler/functions/print.js"></script>
<script src="src/compiler/functions/printLog.js"></script>
<script src="src/compiler/functions/round.js"></script>
<script src="src/compiler/functions/sin.js"></script>
<script src="src/compiler/functions/sinDeg.js"></script>
<script src="src/compiler/functions/sorted.js"></script>
<script src="src/compiler/functions/sqrt.js"></script>
<script src="src/compiler/functions/tan.js"></script>
<script src="src/compiler/functions/tanDeg.js"></script>
<script src="src/compiler/functions/vect.js"></script>
<script src="src/compiler/functions/vectorTowards.js"></script>
<script src="src/compiler/functions/waitUntil.js"></script>
<script src="src/compiler/tokenizer.js"></script>
<script src="src/compiler/astParser.js"></script>
<script src="src/compiler/astToWorkshop.js"></script>
<script src="src/compiler/parser.js"></script>
<script src="src/compiler/compiler.js"></script>
<script src="src/data/localizedStrings.js"></script>

<script>
	
</script>

<script src="codemirror.min.js"></script>

<script>

	const {basicSetup} = CM["codemirror"];
	const {EditorView, keymap} = CM["@codemirror/view"];
	const {indentWithTab, defaultKeymap, history, historyKeymap} = CM["@codemirror/commands"];
	const {LRLanguage, LanguageSupport, StreamLanguage, HighlightStyle, syntaxHighlighting, indentUnit, foldNodeProp, foldInside, indentNodeProp} = CM["@codemirror/language"]
	const {styleTags, tags} = CM["@lezer/highlight"]
	const {LRParser} = CM["@lezer/lr"]

	function getIndentForLine(state, line) {
		const spaces = /^\s*/.exec(state.doc.lineAt(line).text)?.[0].length
		const tabs = /^\t*/.exec(state.doc.lineAt(line).text)?.[0].length
		return Math.floor(spaces / 4) + tabs
	}

	function autoIndentOnEnter({ state, dispatch }) {
		const changes = state.changeByRange(range => {
		const { from, to } = range, line = state.doc.lineAt(from)

		const indent = getIndentForLine(state, from)
		let insert = "\n"
		for (let i = 0; i < indent; i++) { insert += "    " }

		const openBracket = /[\{\(\[]/gm.exec(state.doc.lineAt(from).text)?.[0].length
		const closeBracket = /[\}\)\]]/gm.exec(state.doc.lineAt(from).text)?.[0].length
		if (openBracket && !closeBracket) insert += "    "

		return { changes: { from, to, insert }, range: EditorSelection.cursor(from + insert.length) }
		})

		dispatch(state.update(changes, { scrollIntoView: true, userEvent: "input" }))
		return true
	}

	const overpyHighlight = HighlightStyle.define([
		{tag: tags.keyword, color: "#C586C0"},
		{tag: tags.operator, color: "#569cd6"},
		{tag: tags.variableName, color: "#9CDCFE"},
		{tag: tags.string, color: "#ce9178"},
		{tag: tags.escape, color: "#d7ba7d"},
		{tag: tags.annotation, color: "#d16969"},
		{tag: tags.attributeValue, color: "#6796e6"},
		{tag: tags.number, color: "#b5cea8"},
		{tag: tags.labelName, color: "#4EC9B0"},
		{tag: tags.comment, color: "#6A9955"},
		{tag: tags.macroName, color: "#569cd6"},
		{tag: tags.invalid, color: "#f44747"},
		{tag: tags.propertyName, color: "#4FC1FF"},
		{tag: tags.processingInstruction, color: "#DCDCAA"},
		{tag: tags.className, color: "#d7ba7d"},
		{tag: tags.modifier, color: "#9CDCFE"},
	])

	const overpyLanguage = {
		startState: function() {
			return {
				isInLineComment: false,
				isInMultilineComment: false,
				stringChar: null,
				isInMacro: false,
				isInAnnotation: false,
				isInGoto: false,

			}
		},
		token: function(stream, state) {
			if (stream.eatSpace()) {
				return null;
			}
			if (stream.eol()) {
				return null;
			}
			//console.log("current: |"+stream.peek()+"|, string char: |"+state.stringChar+"|");
			if (state.stringChar) {
				if (stream.match(/\\([\\"'nrtzbf]|x[0-9a-fA-F]{2}|u[0-9a-fA-F]{4}|&\w+;)/)) {
					return "escape";
				}
				if (stream.peek() === state.stringChar) {
					state.stringChar = null;
				}
				stream.next();
				return "string";
			}
			if (state.isInAnnotation) {
				state.isInAnnotation = false
				stream.skipToEnd();
				return "attributeValue";
			}
			if (state.isInGoto) {
				state.isInGoto = false
				stream.skipToEnd();
				return "labelName";
			}
			if (state.isInLineComment) {
				if (!stream.match(/.*\\ *$/)) {
					state.isInLineComment = false;
				}
				stream.skipToEnd();
				return "comment";
			}
			if (state.isInMultilineComment) {
				if (stream.match("*/")) {
					state.isInMultilineComment = false;
				} else {
					stream.next();
				}
				return "comment";
			}
			if (state.isInMacro) {
				if (!stream.match(/.*\\ *$/)) {
					state.isInMacro = false;
				}
				stream.skipToEnd();
				return "macroName";
			}
			if (stream.match(/(goto)\b/)) {
				state.isInGoto = true;
				return "keyword";
			}
			if (stream.match(/\b[a-z]+(?=["'])/)) {
				return "modifier";
			}
			if (stream.match(/(if|else|elif|do|while|for|return|continue|false|true|null|lambda|pass|del|break|switch|case|default|def|rule|settings|globalvar|playervar|subroutine|unsigned|signed|int|float|bool|enum)\b/)) {
				return "keyword";
			}
			if (stream.match(/(False|True|None|Null|class|finally|is|try|from|nonlocal|with|as|yield|assert|except|raise|disabled|import)\b/)) {
				return "invalid";
			}
			if (stream.match("/*")) {
				state.isInMultilineComment = true;
				return "comment";
			}
			if (stream.match(/(and|or|not|in)\b|((\+|\-|\*\*|\/|\%|\*|<|>)=?)|(\=)|\.|((min|max|\!)\=)/)) {
				return "operator";
			}
			if (stream.match(/(eventPlayer|attacker|victim|eventDamage|eventHealing|eventWasCriticalHit|eventWasEnvironment|eventWasHealthPack|eventAbility|eventDirection|healee|healer|hostPlayer|localPlayer|loc|RULE_CONDITION|RULE_START|__\w+__|[A-Z]|[A-D][A-Z])\b/)) {
				return "variable";
			}
			if (stream.match(/[A-Z_\d]+\b/)) {
				return "propertyName";
			}
			if (stream.match(/\b\w+(?=\()/)) {
				return "processingInstruction";
			}
			if (stream.match(/\b[A-Z][a-z_]\w*\b/)) {
				return "className";
			}
			if (stream.match(/@(Event|Hero|Team|Slot|SuppressWarnings)+\b/)) {
				state.isInAnnotation = true;
				return "annotation";
			}
			if (stream.match(/@\w+\b/)) {
				return "annotation";
			}
			if (stream.match(/\b[+-]?(\d*\.)?\d+\b/)) {
				return "number";
			}
			if (stream.match(/[A-Za-z\d_]+(?=:)/)) {
				return "labelName"
			}
			if (stream.match(/\w+/)) {
				return null;
			}
			if (stream.match("#!")) {
				state.isInMacro = true;
				return "macroName";
			}
			if (stream.match("#")) {
				state.isInLineComment = true;
				return "comment";
			}
			var char = stream.next().toString();
			//console.log(char);
			if (char === "'" || char === '"') {
				state.stringChar = char;
				return "string"
			}
			return null;
		}
	}

	var overpyTextEditorView = new EditorView({
		doc: `
#!define GAMEMODE_CODE "14WON"

#!define i18n() __script__("i18n.js")

#!define getKeyboardSelectedKey() updateEveryTick((\\
    [1,2,3,4,5,6,7,8,9,10][(floor((CURSOR_X-KEYBOARD_TOP_LEFT_X)/HORIZONTAL_KEY_DISTANCE))] if KEYBOARD_TOP_LEFT_Y <= CURSOR_Y and CURSOR_Y <= KEYBOARD_TOP_LEFT_Y+KEY_SIDE_LENGTH and (CURSOR_X-KEYBOARD_TOP_LEFT_X)%HORIZONTAL_KEY_DISTANCE <= HORIZONTAL_KEY_DISTANCE else\\
     null\\
) or [""])

rule "GAME MEDKIT NERF":
    @Event playerReceivedHealing
    @Hero all
    @Condition eventWasHealthPack and eventPlayer == hostPlayer
    
    eventPlayer.setStatusEffect(null, Status.HACKED, 5)
    eventPlayer.setMoveSpeed(75)
	A = "owo\\nuwu\\x03\\uFFFE\\"f"
	B = p'te\\zst'
    wait(5) #comment, backslashed \\  
	C = 3
	goto bruh
    eventPlayer.setMoveSpeed(100) #comment 1
	bruh:
	qsdffd = -3.5
    eventPlayer./*setStatusEffect(null, Status.HACKED, 5)
    eventPlayer.*/setMoveSpeed(75)
	` && "",
		extensions: [
			syntaxHighlighting(overpyHighlight),
			StreamLanguage.define(overpyLanguage),
			history(),
			indentUnit.of("    "),
			keymap.of([
				indentWithTab, 
				...defaultKeymap, 
				...historyKeymap,
          		{ key: "Enter", run: autoIndentOnEnter },
			]),
			basicSetup,
		],
		parent: document.getElementById("cm-overpy-text")
	})
</script>

<script>

function getTextareaLineNumber(textarea, name) {
		
	document.getElementById(name+"-textarea-line-number").innerHTML = textarea.value.substr(0, textarea.selectionStart).split("\n").length;
	document.getElementById(name+"-textarea-col-number").innerHTML = textarea.selectionStart - textarea.value.substr(0, textarea.selectionStart).lastIndexOf("\n");
}

function demoDecompile() {
	
    var str = " ";
    var language = document.getElementById("languageInput").value;
    
	try {
        str = decompileAllRules(document.getElementById("workshop-textarea").value, language);
	} catch (e) {
		console.log(e);
		str = e;
	}
	//document.getElementById("overpy-textarea").value = str;
	overpyTextEditorView.dispatch({
		changes: {from: 0, to: overpyTextEditorView.state.doc.length, insert: str}
	})
}

function demoCompile() {
	
	var str = "";
    var language = document.getElementById("languageInput").value;
	try {
		compilationResult = compile(overpyTextEditorView.state.doc.toString(), language);
		str += "//Elements: "+compilationResult.nbElements+"\n";
		if (compilationResult.activatedExtensions.length > 0) {
			str += "//Extension points: "+compilationResult.spentExtensionPoints+"/"+(compilationResult.availableExtensionPoints < 0 ? "unknown" : compilationResult.availableExtensionPoints)+"\n"
		}
		str += compilationResult.result;
		if (compilationResult.encounteredWarnings.length > 0) {
			var strWarn = "/* Warnings were encountered:\n\n"
			for (var warning of compilationResult.encounteredWarnings) {
				strWarn += " - "+warning+"\n\n";
			}
			strWarn += "*/\n";
			str = strWarn+str;
		}
	} catch (e) {
		console.log(e);
		str = e;
	}
	document.getElementById("compiled-textarea").value = str;
}

function demoAddText() {
	document.getElementById("workshop-textarea").value = decompileTest;
	document.getElementById("overpy-textarea").value = "";
	document.getElementById("compiled-textarea").value = "";
	
}

</script>
</body>
</html>